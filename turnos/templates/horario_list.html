{% extends 'baselist.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Buscar Horario
{% endblock %}

{% block tlista %} Listado de {% if empleado %} Turnos para empleado {% else %} Turnos {% endif %} {% endblock %}

{% block tExtras %}     
    
{% endblock %}

{% block cmain %} 
    {% for msg in messages %}
    <div class="alert {% if msg.tags == 'error' %}alert-danger{% else %}alert-{{ msg.tags }}{% endif %} alert-dismissible fade show" role="alert">
        <strong>Hey!</strong> {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}

    <!--Filtro cabecera-->
    <div class="col-12 col-md-3 mx-auto">
        <div class="card flex-fill border-0">
            <div class="card-body py-4">
                    {% crispy filtros filtros.helper %}
                    {{ serialized }}
            </div>
        </div>
    </div>

    <div class="col-12 col-md-9 mx-auto">
        <div class="card flex-fill border-0">
            <div class="card-body py-4 pb-2">
                <div id="calendar"></div>
            </div>
            <div class="modal fade" id="nuevoHorarioModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="formNuevoHorario" method="post" action="{% url 'turnos:crearHorarioParaEmpleado' empleado.pk %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title">Nuevo Horario</h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="servicioSelect">Servicio:</label>
                                    {{ form.servicio }}
                                </div>
                                <div class="mb-3">
                                    <label for="fechaInicio">Fecha de inicio:</label>
                                    {{ form.fecha_inicio }}
                                </div>
                                <div class="mb-3">
                                    <label for="fechaFin">Fecha de fin:</label>
                                    {{ form.fecha_fin }}
                                </div>
                            </div>
                            <!-- <div id="error-superposicion" style="color:red; display:none;"></div> -->
                            <div class="modal-footer">
                                <button id="submit-btn" type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
              
            <!-- Modal para ver detalles -->
            <div class="modal fade" id="detalleHorarioModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalle del Horario</h5>
                        </div>
                        <div class="modal-body">
                            <p><strong>Servicio:</strong> <span id="detalleServicio"></span></p>
                            <p><strong>Inicio:</strong> <span id="detalleInicio"></span></p>
                            <p><strong>Fin:</strong> <span id="detalleFin"></span></p>

                            <!-- Checkbox de asistencia -->
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="checkboxAsistencia">
                                <label class="form-check-label" for="checkboxAsistencia">
                                    Asistencia
                                </label>
                            </div>
                        </div>

                        <!-- Botón para guardar asistencia -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" id="btnEliminarHorario">Eliminar horario</button>
                            <button type="button" class="btn btn-primary" id="btnGuardarAsistencia">Guardar asistencia</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block extrajs %}

<script>
    let idTurnoSeleccionado = null;

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var today = new Date(); 

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: today,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
            },
            navLinks: true,
            selectable: true,
            selectMirror: true,
            editable: true,
            dayMaxEvents: true,
            events: {{ events|safe }},

            dateClick: function(info) {
                const hoySinHora = new Date();
                hoySinHora.setHours(0, 0, 0, 0);
                const fechaSinHora = new Date(info.dateStr);
                fechaSinHora.setHours(0, 0, 0, 0);

                if (fechaSinHora < hoySinHora) {
                    alert("No se pueden crear horarios en fechas anteriores a hoy.");
                    return;
                }

                const hoy = new Date().toISOString().slice(0,16);
                document.getElementById('fechaInicio').min = hoy;
                document.getElementById('fechaFin').min = hoy;

                const fechaSeleccionada = new Date(info.dateStr).toISOString().slice(0, 16);
                document.getElementById('fechaInicio').value = fechaSeleccionada;
                document.getElementById('fechaFin').value = fechaSeleccionada;

                new bootstrap.Modal(document.getElementById('nuevoHorarioModal')).show();
            },

            eventClick: function(info) {
                const evento = info.event;

                idTurnoSeleccionado = evento.id;

                document.getElementById("detalleServicio").textContent = evento.title;

                const opciones = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };

                const fechaInicio = evento.start ? new Date(evento.start).toLocaleString('es-AR', opciones) : 'N/A';
                const fechaFin = evento.end ? new Date(evento.end).toLocaleString('es-AR', opciones) : 'N/A';
                const asistencia = evento.extendedProps.asistencia;

                document.getElementById("detalleInicio").textContent = fechaInicio;
                document.getElementById("detalleFin").textContent = fechaFin;

                document.getElementById("checkboxAsistencia").checked = !!asistencia;

                new bootstrap.Modal(document.getElementById('detalleHorarioModal')).show();
            }
        });

        calendar.render();

        const serviciosInfo = {{ servicios_info|safe }};
        console.log("Servicios Info desde Django:", serviciosInfo);

        const servicioSelect = document.getElementById("servicioSelect");
        const fechaInicioInput = document.getElementById("fechaInicio");
        const fechaFinInput = document.getElementById("fechaFin");

        if (servicioSelect) {
            servicioSelect.addEventListener("change", function() {
                const servicioId = this.value;
                const info = serviciosInfo[servicioId];

                if (info) {
                    fechaInicioInput.min = info.desde;
                    fechaInicioInput.max = info.hasta;
                    fechaFinInput.min = info.desde;
                    fechaFinInput.max = info.hasta;
                } else {
                    fechaInicioInput.removeAttribute("min");
                    fechaInicioInput.removeAttribute("max");
                    fechaFinInput.removeAttribute("min");
                    fechaFinInput.removeAttribute("max");
                }
            });
        }

        // Guardar asistencia al presionar el botón
        document.getElementById("btnGuardarAsistencia").addEventListener("click", function () {
            const asistencia = document.getElementById("checkboxAsistencia").checked;

            fetch(`/turnos/api/turnos/${idTurnoSeleccionado}/asistencia/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ asistencia: asistencia })
            })
            .then(res => res.json())
            .then(data => {
                alert("Asistencia actualizada correctamente.");
                if (data.asistencia !== undefined) {
                    document.getElementById("checkboxAsistencia").checked = data.asistencia;
                }
                const event = calendar.getEventById(idTurnoSeleccionado);
                if (event) {
                    event.setExtendedProp('asistencia', data.asistencia);
                }
                bootstrap.Modal.getInstance(document.getElementById('detalleHorarioModal')).hide();
                calendar.refetchEvents();  
            })
            .catch(error => {
                console.error(error);
                alert("Error al guardar la asistencia.");
            });
        });

        // Eliminar horario ------------------------------------
        document.getElementById("btnEliminarHorario").addEventListener("click", () => {
            if (!confirm("¿Estás seguro de que deseas eliminar este horario?")) {
                return;
            }

            fetch(`/turnos/api/turnos/${idTurnoSeleccionado}/`, {
                method: "DELETE",                           // o "POST"
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"), // necesario si usas POST
                },
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // 1 – quitarlo del calendario en memoria
                    const ev = calendar.getEventById(idTurnoSeleccionado);
                    if (ev) ev.remove();

                    // 2 – cerrar modal
                    bootstrap.Modal
                            .getInstance(
                                document.getElementById("detalleHorarioModal")
                            ).hide();

                    alert("Horario eliminado correctamente.");
                } else {
                    throw new Error(data.error || "Error desconocido");
                }
            })
            .catch(err => {
                console.error(err);
                alert("No se pudo eliminar el horario.");
            });
        });

        // obtengo el CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>


{% endblock %}