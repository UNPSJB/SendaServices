{% extends 'baselist.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Buscar Horario
{% endblock %}

{% block tlista %} Listado de {% if empleado %} Turnos para empleado {% else %} Turnos {% endif %} {% endblock %}

{% block tExtras %}     
    
{% endblock %}

{% block cmain %} 
    {% for msg in messages %}

    <div class="alert {% if msg.tags != "error" %} alert-{{msg.tags}} {% else %} alert-danger {% endif %} alert-dismissible fade show" role="alert">
        <strong>Hey!</strong> {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
        
    {% endfor %}

    <!--Filtro cabecera-->
    <div class="col-12 col-md-3 mx-auto">
        <div class="card flex-fill border-0">
            <div class="card-body py-4">
                    {% crispy filtros filtros.helper %}
                    {{ serialized }}
            </div>
        </div>
    </div>

    <div class="col-12 col-md-9 mx-auto">
        <div class="card flex-fill border-0">
            <div class="card-body py-4 pb-2">
                {% comment %} {% if empleado %}
                    <a href="{% url 'turnos:crearHorarioParaEmpleado' empleado.pk %}" class="bi bi-plus-circle-fill text-success fs-5"></a>
                {% endif %} {% endcomment %}
                <div id="calendar"></div>
            </div>
            <div class="modal fade" id="nuevoHorarioModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="formNuevoHorario" method="post" action="{% url 'turnos:crearHorarioParaEmpleado' empleado.pk %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title">Nuevo Horario</h5>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="servicioSelect">Servicio:</label>
                                    {% comment %} <select id="servicioSelect" class="form-select" required>
                                        {% for s in servicios %}
                                            <option value="{{ s.id }}">{{ s }}</option>
                                        {% endfor %}
                                    </select> {% endcomment %}
                                    {{ form.servicio }}
                                </div>
                                <div class="mb-3">
                                    <label for="fechaInicio">Fecha de inicio:</label>
                                    {% comment %} <input type="date" class="form-control" id="fechaInicio" required> {% endcomment %}
                                    {{ form.fecha_inicio }}
                                </div>
                                <div class="mb-3">
                                    <label for="fechaFin">Fecha de fin:</label>
                                    {% comment %} <input type="date" class="form-control" id="fechaFin" required> {% endcomment %}
                                    {{ form.fecha_fin }}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
              
            <!-- Modal para ver detalles -->
            <div class="modal fade" id="detalleHorarioModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalle del Horario</h5>
                        </div>
                        <div class="modal-body">
                            <p><strong>Servicio:</strong> <span id="detalleServicio"></span></p>
                            <p><strong>Inicio:</strong> <span id="detalleInicio"></span></p>
                            <p><strong>Fin:</strong> <span id="detalleFin"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block extrajs %}

<script>

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var today = new Date(); 

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: today,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
            },
            navLinks: true, // can click day/week names to navigate views
            selectable: true,
            selectMirror: true,
            editable: true,
            dayMaxEvents: true, // allow "more" link when too many events
            // events: {{ events|safe }},
            events: [
                {% for horario in object_list %}
                {
                    title: "{{ horario.servicio }}",
                    start: "{{ horario.fecha_inicio | date:'Y-m-d' }}",
                    end: "{{ horario.fecha_fin | date:'Y-m-d' }}",
                    //url: 'turnos/horarios/<int:pk>/listar/horarios/<int:pk>/crear/',
                },
                {% endfor %}
            ],

            dateClick: function(info) {
                document.getElementById('fechaInicio').value = info.dateStr;
                document.getElementById('fechaFin').value = info.dateStr;
                new bootstrap.Modal(document.getElementById('nuevoHorarioModal')).show();
            },
    
            eventClick: function(info) {
                const props = info.event.extendedProps;
                document.getElementById('detalleServicio').innerText = info.event.title;
                document.getElementById('detalleInicio').innerText = props.fechaInicio;
                document.getElementById('detalleFin').innerText = props.fechaFin;
                new bootstrap.Modal(document.getElementById('detalleHorarioModal')).show();
            }
        });
        calendar.render();

        // Manejo del formulario para crear nuevo evento
    });

</script>

{% endblock %}